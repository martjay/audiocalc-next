# 音频计算器 · 参数计算说明（当前实现）

本文档总结 `index/index.html` 中混响、延迟、压缩的实际计算方法（以当前代码为准）。用于二次开发与核对。

## 术语与基础

- BPM: 每分钟节拍数
- quarter: 单四分音符毫秒数 = 60000 / BPM
- whole: 单全音符毫秒数 = quarter × 4
- clamp(a, min, max): 将 a 约束在 [min, max]

---

## 一、延迟（Delay）

计算入口：`calculateDelay(bpm)`

公式：

- base = quarter × multiplier
- standard = base
- dotted = base × 1.5
- triplet = base × 0.6667

分音符乘数表（configs.delay）：

- 1/2 → 2
- 1/4 → 1
- 1/8 → 0.5
- 1/16 → 0.25
- 1/32 → 0.125
- 1/64 → 0.0625

显示：保留 2 位小数。

中文说明（一步一步怎么算）：

1) 先把 BPM 换算成单拍时长：quarter = 60000 ÷ BPM（单位：毫秒）。

2) 找到所需音符的倍率 multiplier（例如 1/8 是 0.5，1/4 是 1）。

3) 基础时长 base = quarter × multiplier。

4) 三种常见值：
- 标准（Standard）= base
- 附点（Dotted）= base × 1.5（多出一半时值）
- 三连音（Triplet）= base × 2 ÷ 3 ≈ base × 0.6667

举例（BPM=120）：quarter = 60000 ÷ 120 = 500ms；
- 1/8 标准：500 × 0.5 = 250ms；附点：250 × 1.5 = 375ms；三连音：250 × 0.6667 ≈ 166.67ms。

---

## 二、混响（Reverb）

计算入口：`calculateReverb(bpm)`

中间量：
- unit = 60000 / BPM（单拍毫秒）
- beats = cfg.beatsFactor（等效拍数）
- total = unit × beats（总时长）

公式：

- predelay = total / predelayDivisor
- decay = total − predelay

配置（configs.reverb）：

- Hall: beatsFactor 8, predelayDivisor 64
- small Plate: beatsFactor 2.4, predelayDivisor 128
- fat Plate: beatsFactor 3.9, predelayDivisor 96
- Large Room: beatsFactor 4, predelayDivisor 64
- Small Room: beatsFactor 2, predelayDivisor 64
- Tight Ambience: beatsFactor 1, predelayDivisor 128

显示：保留 2 位小数。

中文说明（一步一步怎么算）：

1) 把 BPM 换算成单拍时长：unit = 60000 ÷ BPM。

2) 计算该类型的等效拍数：total = unit × beatsFactor（例如 Hall=8 表示 8 拍长度）。

3) 预延迟：predelay = total ÷ predelayDivisor（类型内置比例，通常较小）。

4) 衰减时间：decay = total − predelay（把总时长扣掉预延迟部分）。

举例（BPM=120，Hall）：unit=500ms，total=500×8=4000ms；若 divisor=64，则 predelay=4000÷64=62.5ms；decay=4000−62.5=3937.5ms。

---

## 三、压缩（Compressor）

### 3.1 预设压缩（Preset）

计算入口：`calculateCompressorPresets(bpm)`

中间量：
- quarter = 60000 / BPM
- whole = quarter × 4

公式（与自定义一致，阈值联动 ±20%）：

- tf = clamp01( (threshold + 60) / 60 )
- aF = attackFactor × (1 − (tf − 0.5) × 0.4)
- rF = releaseFactor × (1 + (tf − 0.5) × 0.4)
- attack = clamp( quarter × aF, 0.5, 100 )（ms）
- release = clamp( whole × rF, 10, 2000 )（ms）
- ratio 直接取配置值，以 `X:1` 显示

配置（configs.compressorPresets）：

- Vocals: threshold −18（仅显示），attackFactor 0.005，releaseFactor 0.15，ratio 4
- Drums: threshold −15（仅显示），attackFactor 0.002，releaseFactor 0.08，ratio 6
- Bass: threshold −12（仅显示），attackFactor 0.01，releaseFactor 0.18，ratio 4
- Piano: threshold −14（仅显示），attackFactor 0.008，releaseFactor 0.20，ratio 3
- Guitar: threshold −16（仅显示），attackFactor 0.006，releaseFactor 0.16，ratio 4
- Master: threshold −6（仅显示），attackFactor 0.02，releaseFactor 0.25，ratio 2

说明：为保证左右两侧可对照，预设也启用同一阈值联动模型；当左右阈值一致时，结果应一致。

中文说明（一步一步怎么算）：

1) 先得到拍时：quarter = 60000 ÷ BPM，whole = quarter × 4。

2) 把阈值（范围 −60dB 到 0dB）映射为 0~1 的权重：
   tf = ((threshold + 60) ÷ 60) 再夹到 [0.1, 1]（避免极端值）。

3) 根据 tf 对不同素材的系数做“温和”修正（最多 ±20%）：
   aF = attackFactor × [1 − (tf − 0.5) × 0.4]
   rF = releaseFactor × [1 + (tf − 0.5) × 0.4]
   直观理解：阈值越低（更负），tf 越小 → Attack 略变短，Release 略变长；反之亦然。

4) 计算时间：
   attack = quarter × aF，随后夹到 [0.5, 100] 毫秒；
   release = whole × rF，随后夹到 [10, 2000] 毫秒。

5) 压缩比（ratio）为经验值，直接显示为 “X:1”。

小例（BPM=120，人声，threshold=−18）：
quarter=500ms，whole=2000ms；tf=(−18+60)/60=0.7；
aF=0.005×[1−(0.7−0.5)×0.4]=0.005×0.92=0.0046；
attack=500×0.0046=2.3ms；
rF=0.15×[1+(0.7−0.5)×0.4]=0.15×1.08=0.162；
release=2000×0.162=324ms；ratio=4:1。

### 3.2 自定义压缩（Custom）

计算入口：`calculateCustomCompressor(bpm, type, threshold)`

说明：自定义压缩支持阈值联动：阈值会对 Attack/Release 产生约 ±20% 的温和影响，用于个性化微调。

中间量：
- quarter = 60000 / BPM
- whole = quarter × 4
- thresholdClamp: 将输入阈值约束到 [−60, 0]
- tf = clamp01( (threshold + 60) / 60 ) ∈ [0,1]

计算：

- aF = attackFactor × (1 − (tf − 0.5) × 0.4)
- rF = releaseFactor × (1 + (tf − 0.5) × 0.4)
- attack = clamp( quarter × aF, 0.5, 100 )（ms）
- release = clamp( whole × rF, 10, 2000 )（ms）
- ratio 直接取配置值（显示为 `X:1`）

中文说明（与预设相同的步骤）：

1) quarter = 60000 ÷ BPM，whole = quarter × 4。

2) tf = ((threshold + 60) ÷ 60)，并限制在 [0.1, 1]。

3) aF = attackFactor × [1 − (tf − 0.5) × 0.4]；rF = releaseFactor × [1 + (tf − 0.5) × 0.4]。

4) attack = clamp(quarter × aF, 0.5, 100)；release = clamp(whole × rF, 10, 2000)。

5) ratio 显示为 “X:1”。

提示：
- 想更“保留瞬态”（鼓、人声更有冲击），适当“加长” Attack 或把阈值升高（接近 0）；
- 想更“稳定/厚重”，适当“加长” Release 或把阈值降低（更负）；
- 结果被夹到安全范围，避免极端数值影响可用性。

配置（configs.customCompressor）：

- Vocals: attackFactor 0.005，releaseFactor 0.15，ratio 4
- Drums: attackFactor 0.002，releaseFactor 0.08，ratio 6
- Bass: attackFactor 0.01，releaseFactor 0.18，ratio 4
- Piano: attackFactor 0.008，releaseFactor 0.20，ratio 3
- Guitar: attackFactor 0.006，releaseFactor 0.16，ratio 4
- Master: attackFactor 0.02，releaseFactor 0.25，ratio 2

---

## 四、显示与交互要点

- 所有结果显示为纯文本（避免某些 WebView 环境下渐变文字透明导致不可见）。
- 结果单元格支持点击复制（含键盘 Enter/Space），并弹出轻量提示。
- 预设表第 2 列阈值同样可复制文本。
- 自定义阈值输入被约束在 [−60, 0] 区间。

---

## 五、参考/备注

- 动态处理的权威数学模型：
  - 静态压缩曲线：`y = T + (x − T)/R`（软膝可做平滑扩展）
  - 包络检测时间常数：`α = 1 − exp(−1/(τ·fs))`（Attack/Release）
- 本项目的 BPM → 时间参数映射为经验型工程规则，便于快速与节拍对齐和通用混音实践。


