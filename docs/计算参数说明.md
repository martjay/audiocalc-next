# 音频计算器 · 参数计算说明（当前实现）

本文档总结 `index/index.html` 中混响、延迟、压缩的实际计算方法（以当前代码为准）。用于二次开发与核对。

## 术语与基础

- BPM: 每分钟节拍数
- quarter: 单四分音符毫秒数 = 60000 / BPM
- whole: 单全音符毫秒数 = quarter × 4
- clamp(a, min, max): 将 a 约束在 [min, max]

---

## 一、延迟（Delay）

计算入口：`calculateDelay(bpm)`

公式：

- base = quarter × multiplier
- standard = base
- dotted = base × 1.5
- triplet = base × 0.6667

分音符乘数表（configs.delay）：

- 1/2 → 2
- 1/4 → 1
- 1/8 → 0.5
- 1/16 → 0.25
- 1/32 → 0.125
- 1/64 → 0.0625

显示：保留 2 位小数。

---

## 二、混响（Reverb）

计算入口：`calculateReverb(bpm)`

中间量：
- unit = 60000 / BPM（单拍毫秒）
- beats = cfg.beatsFactor（等效拍数）
- total = unit × beats（总时长）

公式：

- predelay = total / predelayDivisor
- decay = total − predelay

配置（configs.reverb）：

- Hall: beatsFactor 8, predelayDivisor 64
- small Plate: beatsFactor 2.4, predelayDivisor 128
- fat Plate: beatsFactor 3.9, predelayDivisor 96
- Large Room: beatsFactor 4, predelayDivisor 64
- Small Room: beatsFactor 2, predelayDivisor 64
- Tight Ambience: beatsFactor 1, predelayDivisor 128

显示：保留 2 位小数。

---

## 三、压缩（Compressor）

### 3.1 预设压缩（Preset）

计算入口：`calculateCompressorPresets(bpm)`

中间量：
- quarter = 60000 / BPM
- whole = quarter × 4

公式（与自定义一致，阈值联动 ±20%）：

- tf = clamp01( (threshold + 60) / 60 )
- aF = attackFactor × (1 − (tf − 0.5) × 0.4)
- rF = releaseFactor × (1 + (tf − 0.5) × 0.4)
- attack = clamp( quarter × aF, 0.5, 100 )（ms）
- release = clamp( whole × rF, 10, 2000 )（ms）
- ratio 直接取配置值，以 `X:1` 显示

配置（configs.compressorPresets）：

- Vocals: threshold −18（仅显示），attackFactor 0.005，releaseFactor 0.15，ratio 4
- Drums: threshold −15（仅显示），attackFactor 0.002，releaseFactor 0.08，ratio 6
- Bass: threshold −12（仅显示），attackFactor 0.01，releaseFactor 0.18，ratio 4
- Piano: threshold −14（仅显示），attackFactor 0.008，releaseFactor 0.20，ratio 3
- Guitar: threshold −16（仅显示），attackFactor 0.006，releaseFactor 0.16，ratio 4
- Master: threshold −6（仅显示），attackFactor 0.02，releaseFactor 0.25，ratio 2

说明：为保证左右两侧可对照，预设也启用同一阈值联动模型；当左右阈值一致时，结果应一致。

### 3.2 自定义压缩（Custom）

计算入口：`calculateCustomCompressor(bpm, type, threshold)`

说明：自定义压缩支持阈值联动：阈值会对 Attack/Release 产生约 ±20% 的温和影响，用于个性化微调。

中间量：
- quarter = 60000 / BPM
- whole = quarter × 4
- thresholdClamp: 将输入阈值约束到 [−60, 0]
- tf = clamp01( (threshold + 60) / 60 ) ∈ [0,1]

计算：

- aF = attackFactor × (1 − (tf − 0.5) × 0.4)
- rF = releaseFactor × (1 + (tf − 0.5) × 0.4)
- attack = clamp( quarter × aF, 0.5, 100 )（ms）
- release = clamp( whole × rF, 10, 2000 )（ms）
- ratio 直接取配置值（显示为 `X:1`）

配置（configs.customCompressor）：

- Vocals: attackFactor 0.005，releaseFactor 0.15，ratio 4
- Drums: attackFactor 0.002，releaseFactor 0.08，ratio 6
- Bass: attackFactor 0.01，releaseFactor 0.18，ratio 4
- Piano: attackFactor 0.008，releaseFactor 0.20，ratio 3
- Guitar: attackFactor 0.006，releaseFactor 0.16，ratio 4
- Master: attackFactor 0.02，releaseFactor 0.25，ratio 2

---

## 四、显示与交互要点

- 所有结果显示为纯文本（避免某些 WebView 环境下渐变文字透明导致不可见）。
- 结果单元格支持点击复制（含键盘 Enter/Space），并弹出轻量提示。
- 预设表第 2 列阈值同样可复制文本。
- 自定义阈值输入被约束在 [−60, 0] 区间。

---

## 五、参考/备注

- 动态处理的权威数学模型：
  - 静态压缩曲线：`y = T + (x − T)/R`（软膝可做平滑扩展）
  - 包络检测时间常数：`α = 1 − exp(−1/(τ·fs))`（Attack/Release）
- 本项目的 BPM → 时间参数映射为经验型工程规则，便于快速与节拍对齐和通用混音实践。


